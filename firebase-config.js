// Firebase Configuration and Functions
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBt5IR0jg2sye3S1XdWxP0FBWZFP8D4OdQ",
    authDomain: "paedigital2025.firebaseapp.com",
    projectId: "paedigital2025",
    storageBucket: "paedigital2025.firebasestorage.app",
    messagingSenderId: "740229563465",
    appId: "1:740229563465:web:2f740a1f2a33b1ff29ab98"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Hacer las variables globales
window.db = db;
window.auth = auth;
window.collection = collection;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.doc = doc;
window.updateDoc = updateDoc;
window.deleteDoc = deleteDoc;
window.query = query;
window.orderBy = orderBy;
window.where = where;
window.onSnapshot = onSnapshot;

// Funci√≥n para actualizar el indicador de estado
function actualizarIndicadorFirebase(estado, mensaje) {
    const indicador = document.getElementById('indicador-conexion');
    const texto = document.getElementById('firebase-status-text');
    
    if (indicador && texto) {
        indicador.className = `firebase-status ${estado}`;
        texto.textContent = mensaje;
        
        switch(estado) {
            case 'connected':
                indicador.innerHTML = 'üî• Firebase: Conectado';
                break;
            case 'disconnected':
                indicador.innerHTML = 'üî• Firebase: Desconectado';
                break;
            case 'syncing':
                indicador.innerHTML = 'üî• Firebase: Sincronizando...';
                break;
        }
    }
}

// Funci√≥n para mostrar notificaciones de Firebase
function mostrarNotificacionFirebase(mensaje, tipo = 'info') {
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `firebase-notification ${tipo}`;
    notificacion.textContent = mensaje;
    
    // Agregar al DOM
    document.body.appendChild(notificacion);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
        notificacion.classList.add('show');
    }, 100);
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
        notificacion.classList.remove('show');
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 300);
    }, 3000);
}

// Autenticaci√≥n an√≥nima
signInAnonymously(auth).then(() => {
    console.log('‚úÖ Autenticado an√≥nimamente con Firebase');
    actualizarIndicadorFirebase('connected', 'Conectado a Firebase - Datos sincronizados');
}).catch((error) => {
    console.error('‚ùå Error de autenticaci√≥n:', error);
    actualizarIndicadorFirebase('disconnected', 'Error de conexi√≥n - Modo local');
});

// ==================== FUNCIONES PARA MOVIMIENTOS ====================

// Funci√≥n para agregar movimiento a Firebase
window.agregarMovimientoFirebase = async function(movimiento) {
    try {
        const docRef = await addDoc(collection(db, "movimientos"), {
            ...movimiento,
            timestamp: new Date().toISOString(),
            fechaCreacion: new Date().toISOString()
        });
        console.log("‚úÖ Movimiento agregado con ID: ", docRef.id);
        
        // Actualizar localStorage tambi√©n
        const movimientos = JSON.parse(localStorage.getItem('movimientos') || '[]');
        movimientos.unshift({ id: docRef.id, ...movimiento, timestamp: new Date().toISOString() });
        localStorage.setItem('movimientos', JSON.stringify(movimientos));
        
        return docRef.id;
    } catch (error) {
        console.error("‚ùå Error agregando movimiento: ", error);
        throw error;
    }
};

// Funci√≥n para obtener movimientos de Firebase
window.obtenerMovimientosFirebase = async function() {
    try {
        const q = query(collection(db, "movimientos"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);
        const movimientos = [];
        querySnapshot.forEach((doc) => {
            movimientos.push({ id: doc.id, ...doc.data() });
        });
        console.log(`‚úÖ Obtenidos ${movimientos.length} movimientos de Firebase`);
        return movimientos;
    } catch (error) {
        console.error("‚ùå Error obteniendo movimientos: ", error);
        return [];
    }
};

// ==================== FUNCIONES PARA PRODUCTOS ====================

// Funci√≥n para agregar producto a Firebase
window.agregarProductoFirebase = async function(producto) {
    try {
        const docRef = await addDoc(collection(db, "productos"), {
            ...producto,
            ultimaActualizacion: new Date().toISOString(),
            fechaCreacion: new Date().toISOString()
        });
        console.log("‚úÖ Producto agregado con ID: ", docRef.id);
        
        // Actualizar localStorage tambi√©n
        const productos = JSON.parse(localStorage.getItem('productos') || '[]');
        productos.push({ id: docRef.id, ...producto, ultimaActualizacion: new Date().toISOString() });
        localStorage.setItem('productos', JSON.stringify(productos));
        
        return docRef.id;
    } catch (error) {
        console.error("‚ùå Error agregando producto: ", error);
        throw error;
    }
};

// Funci√≥n para obtener productos de Firebase
window.obtenerProductosFirebase = async function() {
    try {
        const querySnapshot = await getDocs(collection(db, "productos"));
        const productos = [];
        querySnapshot.forEach((doc) => {
            productos.push({ id: doc.id, ...doc.data() });
        });
        console.log(`‚úÖ Obtenidos ${productos.length} productos de Firebase`);
        return productos;
    } catch (error) {
        console.error("‚ùå Error obteniendo productos: ", error);
        return [];
    }
};

// Funci√≥n para actualizar producto en Firebase
window.actualizarProductoFirebase = async function(productoId, datosActualizados) {
    try {
        const productoRef = doc(db, "productos", productoId);
        await updateDoc(productoRef, {
            ...datosActualizados,
            ultimaActualizacion: new Date().toISOString()
        });
        console.log("‚úÖ Producto actualizado con ID: ", productoId);
        
        // Actualizar localStorage tambi√©n
        const productos = JSON.parse(localStorage.getItem('productos') || '[]');
        const index = productos.findIndex(p => p.id === productoId);
        if (index !== -1) {
            productos[index] = { ...productos[index], ...datosActualizados, ultimaActualizacion: new Date().toISOString() };
            localStorage.setItem('productos', JSON.stringify(productos));
        }
        
    } catch (error) {
        console.error("‚ùå Error actualizando producto: ", error);
        throw error;
    }
};

// Funci√≥n para eliminar producto de Firebase
window.eliminarProductoFirebase = async function(productoId) {
    try {
        await deleteDoc(doc(db, "productos", productoId));
        console.log("‚úÖ Producto eliminado con ID: ", productoId);
        
        // Actualizar localStorage tambi√©n
        const productos = JSON.parse(localStorage.getItem('productos') || '[]');
        const productosFiltrados = productos.filter(p => p.id !== productoId);
        localStorage.setItem('productos', JSON.stringify(productosFiltrados));
        
    } catch (error) {
        console.error("‚ùå Error eliminando producto: ", error);
        throw error;
    }
};

// ==================== FUNCIONES PARA SEDES ====================

// Funci√≥n para agregar sede a Firebase
window.agregarSedeFirebase = async function(sede) {
    try {
        const docRef = await addDoc(collection(db, "sedes"), {
            ...sede,
            fechaCreacion: new Date().toISOString()
        });
        console.log("‚úÖ Sede agregada con ID: ", docRef.id);
        
        // Actualizar localStorage tambi√©n
        const sedes = JSON.parse(localStorage.getItem('sedes') || '[]');
        sedes.push({ id: docRef.id, ...sede, fechaCreacion: new Date().toISOString() });
        localStorage.setItem('sedes', JSON.stringify(sedes));
        
        return docRef.id;
    } catch (error) {
        console.error("‚ùå Error agregando sede: ", error);
        throw error;
    }
};

// Funci√≥n para obtener sedes de Firebase
window.obtenerSedesFirebase = async function() {
    try {
        const querySnapshot = await getDocs(collection(db, "sedes"));
        const sedes = [];
        querySnapshot.forEach((doc) => {
            sedes.push({ id: doc.id, ...doc.data() });
        });
        console.log(`‚úÖ Obtenidas ${sedes.length} sedes de Firebase`);
        return sedes;
    } catch (error) {
        console.error("‚ùå Error obteniendo sedes: ", error);
        return [];
    }
};

// ==================== FUNCIONES DE SINCRONIZACI√ìN ====================

// Funci√≥n para sincronizar datos locales con Firebase
window.sincronizarConFirebase = async function() {
    try {
        console.log('üîÑ Iniciando sincronizaci√≥n con Firebase...');
        actualizarIndicadorFirebase('syncing', 'Sincronizando datos con Firebase...');
        
        // Obtener datos de Firebase
        const movimientosFirebase = await obtenerMovimientosFirebase();
        const productosFirebase = await obtenerProductosFirebase();
        const sedesFirebase = await obtenerSedesFirebase();

        // Actualizar localStorage con datos de Firebase
        localStorage.setItem('movimientos', JSON.stringify(movimientosFirebase));
        localStorage.setItem('productos', JSON.stringify(productosFirebase));
        localStorage.setItem('sedes', JSON.stringify(sedesFirebase));

        console.log('‚úÖ Datos sincronizados con Firebase');
        actualizarIndicadorFirebase('connected', 'Datos sincronizados con Firebase');
        
        // Mostrar notificaci√≥n de √©xito
        mostrarNotificacionFirebase('Datos sincronizados exitosamente', 'success');
        
        return true;
    } catch (error) {
        console.error('‚ùå Error sincronizando con Firebase:', error);
        actualizarIndicadorFirebase('disconnected', 'Error de sincronizaci√≥n - Modo local');
        mostrarNotificacionFirebase('Error de sincronizaci√≥n con Firebase', 'error');
        return false;
    }
};

// Funci√≥n para migrar datos locales a Firebase
window.migrarDatosAFirebase = async function() {
    try {
        console.log('üîÑ Iniciando migraci√≥n de datos locales a Firebase...');
        
        // Obtener datos locales
        const movimientosLocales = JSON.parse(localStorage.getItem('movimientos') || '[]');
        const productosLocales = JSON.parse(localStorage.getItem('productos') || '[]');
        const sedesLocales = JSON.parse(localStorage.getItem('sedes') || '[]');

        let movimientosMigrados = 0;
        let productosMigrados = 0;
        let sedesMigradas = 0;

        // Migrar movimientos
        for (const movimiento of movimientosLocales) {
            if (movimiento.id && !movimiento.id.startsWith('firebase_')) {
                await agregarMovimientoFirebase(movimiento);
                movimientosMigrados++;
            }
        }

        // Migrar productos
        for (const producto of productosLocales) {
            if (producto.id && !producto.id.startsWith('firebase_')) {
                await agregarProductoFirebase(producto);
                productosMigrados++;
            }
        }

        // Migrar sedes
        for (const sede of sedesLocales) {
            if (sede.id && !sede.id.startsWith('firebase_')) {
                await agregarSedeFirebase(sede);
                sedesMigradas++;
            }
        }

        console.log(`‚úÖ Migraci√≥n completada: ${movimientosMigrados} movimientos, ${productosMigrados} productos, ${sedesMigradas} sedes`);
        return true;
    } catch (error) {
        console.error('‚ùå Error en migraci√≥n:', error);
        return false;
    }
};

// ==================== FUNCIONES DE UTILIDAD ====================

// Funci√≥n para verificar conexi√≥n con Firebase
window.verificarConexionFirebase = async function() {
    try {
        const testDoc = await addDoc(collection(db, "test"), {
            timestamp: new Date().toISOString(),
            test: true
        });
        await deleteDoc(doc(db, "test", testDoc.id));
        console.log('‚úÖ Conexi√≥n con Firebase verificada');
        return true;
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n con Firebase:', error);
        return false;
    }
};

// Funci√≥n para limpiar datos de prueba
window.limpiarDatosPrueba = async function() {
    try {
        console.log('üßπ Limpiando datos de prueba...');
        
        // Obtener todos los documentos de prueba
        const movimientos = await getDocs(collection(db, "movimientos"));
        const productos = await getDocs(collection(db, "productos"));
        const sedes = await getDocs(collection(db, "sedes"));
        
        // Eliminar movimientos de prueba
        for (const doc of movimientos.docs) {
            if (doc.data().producto && doc.data().producto.includes('PRUEBA')) {
                await deleteDoc(doc.ref);
            }
        }
        
        // Eliminar productos de prueba
        for (const doc of productos.docs) {
            if (doc.data().producto && doc.data().producto.includes('PRUEBA')) {
                await deleteDoc(doc.ref);
            }
        }
        
        console.log('‚úÖ Datos de prueba eliminados');
        return true;
    } catch (error) {
        console.error('‚ùå Error limpiando datos de prueba:', error);
        return false;
    }
};

// ==================== INICIALIZACI√ìN ====================

        // Inicializar cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Firebase...');
            
            // Verificar conexi√≥n
            verificarConexionFirebase().then((conectado) => {
                if (conectado) {
                    // Verificar si hay datos locales para migrar
                    const movimientosLocales = JSON.parse(localStorage.getItem('movimientos') || '[]');
                    if (movimientosLocales.length > 0) {
                        console.log('üì¶ Datos locales encontrados, iniciando migraci√≥n...');
                        migrarDatosAFirebase().then(() => {
                            console.log('‚úÖ Migraci√≥n completada, sincronizando...');
                            sincronizarConFirebase();
                        });
                    } else {
                        console.log('üîÑ Sincronizando con Firebase...');
                        sincronizarConFirebase();
                    }
                } else {
                    console.log('‚ö†Ô∏è Usando modo offline (datos locales)');
                }
            });
            
            // Sincronizaci√≥n autom√°tica al cargar la p√°gina
            setTimeout(() => {
                if (window.sincronizarConFirebase) {
                    console.log('üîÑ Sincronizaci√≥n autom√°tica al cargar p√°gina...');
                    sincronizarConFirebase();
                }
            }, 2000); // Esperar 2 segundos para que todo est√© listo
        });

// Exportar para uso global
window.FirebaseConfig = {
    db,
    auth,
    app,
    config: firebaseConfig
};

console.log('üî• Firebase configurado correctamente');
